**DRAFT -- NOT READY**

# How to Write and Submit an Analyzer


## What is an Analyzer ?


An analyzer is a program that takes an observable and
configuration information as **raw input**, analyze the observable and 
produces a result as **raw output**. It is made of at least 2 types of files.

### The Program
The first type of files an analyzer is made of is the core program that 
performs actions. It can be written in any programming 
language that is supported by Linux.

While many analyzers are written in Python (`*.py` files), you can write yours 
in Ruby, Perl or even Scala. However, the very handy `Cortexutils` library is 
in Python. It greatly facilitates analyzer development and it also provides 
some methods to quickly format the output to be compliant with the JSON 
schema expected by [TheHive](https://github.com/CERT-BDF/TheHive/).

### Service Interaction Files (Flavors)
An analyzer must have at least one service interaction file. Such files 
contain key configuration information such as the analyzer's author 
information, the datatypes (IP, URL, hash, domain...) the analyzer accepts as
input, the TLP above which it will refuse to execute to protect against data 
leakage and to enforce sane OPSEC practices and so on.

An analyzer can have two or more service interaction files to allow it to 
perform different actions.  We speak then of flavors.

For example, a sandbox analyzer can analyze a file with or without an 
Internet connection. Another example could be an analyzer that can either 
send a file to VirusTotal for analysis or get the last report using its hash.

### Python Requirements
If the analyzer is written in Python, a `requirements.txt` must be provided 
with the list of all the dependencies.
 
### Example: VirusTotal Analyzer Files

``` {.sourceCode .bash}
analyzers/VirusTotal
├── VirusTotal_GetReport.json
├── VirusTotal_Scan.json
├── requirements.txt
├── virustotal.py
└── virustotal_api.py
```


### Input

The input an analyzer can accept must have a JSON structure with different 
pieces of information. For example, to use the VirusTotal analyzer's 
**GetReport** flavor to obtain the latest available report for hash 
`d41d8cd98f00b204e9800998ecf8427e` , you must submit input such as:


``` {.sourceCode .json}
{
    "data":"d41d8cd98f00b204e9800998ecf8427e",
    "dataType":"hash",
    "tlp":0,
    "config":{
        "key":"1234567890abcdef",
        "max_tlp":3,
        "check_tlp":true,
        "service":"GetReport"
        [..]
    },
    "proxy":{
        "http":"http://myproxy:8080",
        "https":"https://myproxy:8080"
      }
  }
```

`data`, `dataType` and `tlp` are the observable-related information generated by
TheHive or any other program that is calling Cortex. `config` is the 
analyzer's specific set of configuration coming from the configuration
file - `/etc/cortex/application.conf` - and the service configuration
file, `VirusTotal_GetReport.json` for example.

Let's take the **GetReport** flavor of the VirusTotal analyzer as an 
example again:

#### Observable

``` {.sourceCode .json}
{
    "data":"d41d8cd98f00b204e9800998ecf8427e",
    "dataType":"hash",
    "tlp":0,
    [..]
  }
```

#### Configuration of the VirusTotal GetReport Service (or Flavor)

``` {.sourceCode .json}
{
    "name": "VirusTotal_GetReport",
    "version": "3.0",
    "author": "CERT-BDF",
    "url": "https://github.com/CERT-BDF/Cortex-Analyzers",
    "license": "AGPL-V3",
    "description": "Get the latest VirusTotal report for a file, hash, domain or an IP address",
    "dataTypeList": ["file", "hash", "domain", "ip"],
    "baseConfig": "VirusTotal", <== name of base config in /etc/cortex/application.conf
    "config": {
        "check_tlp": true,
        "max_tlp": 3,
        "service": "get"
    },
    "command": "VirusTotal/virustotal.py" <= main program
}
```

### Service Interaction Configuration Items
#### name
Name of the specific service (or flavor) of the analyzer. 

If your analyzer has only one service interaction (i.e. performs only one
action), it is the name of the analyzer's directory. 

If your analyzer performs several actions (i.e. comes in several flavors), 
you have to give a specific and meaningful name to each flavor.

Each flavor's name appear in TheHive's analyzer list and in MISP when you 
use Cortex for enrichment.


#### version
The version of the analyzer. 

You must increase major version numbers when new features are added, 
modifications are made to take into account API changes, report output is 
modified and report templates (more on this later) are updated. 

You must increase minor version numbers when bugs are fixed. 

The version number is also used in the folder name of the associated report 
templates ; e.g. *VirusTotal\_GetReport* and *3.0* on the JSON file should 
correspond a folder named *VirusTotal\_GetReport\_3\_0* for report templates.
 Report templates are used by TheHive to display the analyzer's JSON output 
 in an analyst-friendly fashion.

#### author
You must provide your full name and/or your organization/team name when 
submitting an analyzer. Pseudos are not accepted. If you'd rather remain 
anonymous, please contact us at support@thehive-project.org prior to 
submitting your analyzer.

#### url
The URL where the analyzer is stored. This should be ideally 

#### license
The license of the code. Ideally, we recommend you use the AGPL-v3 
license. 

Make sure your code's license is compatible with the license(s) of the 
various components and libraries you use when applicable.


#### description
Description of the analyzer. Please be concise and clear. 

The description is shown in the Cortex UI, TheHive and MISP.

#### dataTypeList
The list of TheHive datatypes supported by the analyzer. Currently TheHive 
accepts the following datatypes:

- domain	
- file	
- filename	
- fqdn
- hash	
- ip	
- mail	
- mail_subject	
- other	
- regexp	
- registry	
- uri_path	
- url	
- user-agent

If you need additional datatypes for your analyzer, please let us know at 
support@thehive-project.org.

#### baseConfig
Name used for the global configuration in Cortex

    (`/etc/cortex/application.conf`)

#### config
Configuration dedicated to the analyzer's flavor. Typically, this is where we
 typically specify the TLP level of observables allowed to be analyzed with 
 `check_tlp` and `max_tlp`. For example, if `max_tlp` is set to `3`, TLP:RED 
 observables are allowed to be analyzed.

#####  max_tlp
The TLP level above which the analyzer must not be executed.

| TLP   |     max_tlp value     |
|----------|:-------------:|
| Unknown |  -1 |
| WHITE |   0  |
| GREEN | 1 |
| AMBER | 2 |
| RED | 3 |

XXX - PROGRESS MARKER

check\_tlp

:   if `true`, `max_tlp` is checked, else, not. Somehow, we recommand
    setting both `check_tlp` and `max_tlp` even if it is set to `false`.

command

:   command used to run the analyzer, typically path to the main
    program file.

3.  Configuration in `/etc/cortex/application.conf`

``` {.sourceCode .}
analyzer {
    config {
            global {
                    proxy {
                           http="http://myproxy:8080",
                           https="https://myproxy:8080"
                    }
            [..]
            VirusTotal {
                key="1234567890abcdef"
            }
    [..]
```

That way, you can have an analyzer with many services with different
configuration parameters.

### Output

The output of an analyzer varies if it succeeds or not.

-   If the analyzer **fails** :

    ``` {.sourceCode .json}
    {
        "success": false,
        "errorMessage":".."
    }
    ```

    -   `success` sets to `false` indicates that something went wrong
        during the execution,
    -   `errorMessage` is free text - typically the error ouput message.
-   If it **succeeds** - the analyzer run without error :

    ``` {.sourceCode .json}
    {
        "success":true
        "artifacts":[..],
        "summary":{
            "taxonomies":[..]
        },
        "full":{..}
    }
    ```

    -   `success` set to `true` indicates that the analyzer has run
        successfully,
    -   `artifacts` is a list of indicators extracted from the report
    -   `full` is the full report of the analyzer. It is free
        JSON formatted.
    -   `summary` is used in TheHive for short reports displayed in the
        list and in the detailed page of Observables. Since June'17, it
        is formatted to be a list of taxonomies.
        -   `taxonomies`:

        ``` {.sourceCode .json}
        "taxonomies":[
          {
              "namespace": "NAME",
              "predicate": "PREDICATE",
              "value": "\"VALUE\"",
              "level":"info"            <== info/safe/suspicious/malicious
          }
        ]
        ```

        -   `namespace` and `predicate` are free value. For example *VT*
            and *Score*.
        -   `level` intend to tell the maliciousness of the information
            :
            -   `info` : the analyzer produced an information, and the
                short report is shown in blue color in TheHive
            -   `safe` : the analyzer did not find anything suspicious
                or the analyzed observable is safe according to
                the analyzer. TheHive displays the short report in green
                color
            -   `suspicious` : the analyzer found that the observable is
                either suspicious or warrants further investigation. The
                short report is orange colored in TheHive
            -   `malicious` : the analyzer found that the observable
                is malicious. The short report is red colored in TheHive
        -   For more information about `summary()` and `taxonomy`, [a
            blog
            post](https://blog.thehive-project.org/2017/07/05/all-fresh-cortexutils-new-cortex-analyzers/)
            has been published in july'17 and details everything
            with examples.

Cortexutils python library
--------------------------

Until now all analyzers have been written in python and cortexutils
library has been released to help people to easily wite programs. But
python is not mandatory and any language that runs on Linux systems is
allowed.

Cortexutils is a set of classes that aims to make users write Cortex
analyzers easier. It is available for versions 2 and 3 of python.

To install it :

``` {.sourceCode .bash}
pip install cortexutils
```

or

``` {.sourceCode .bash}
pip3 install cortexutils
```

This library is already used by all analyzers released in our [github
repository](https://github.com/CERT-BDF/Cortex-Analyzers). Feel free to
start reading some of them to help you writing your own.

Display into TheHive using templates
------------------------------------

TheHive submits an observable to Cortex for analysis. Once finished,
Cortex returns the result to TheHive. This result is loaded into TheHive
with HTML templates.

### Input result

TheHive input result is simply the JSON formatted analyzer's result
transmitted by Cortex.

-   `summary` is read to display short reports in observables list and
    detailed observable page. In TheHive application, it is stored in a
    **dict** object named `content`.
-   `full` is read to display long reports when clicking the short
    report in observabled list, or in a detailed observable page. In
    TheHive application, it is stored in a **dict** object named
    `content`.

### Output

In the event that analyzers templates are not imported into TheHive :

-   in observables list, TheHive is able to display analyzers `summary`
    results using a builtin style sheet associated with the previously
    described taxonomy.
-   in observables detailed pages, `full` results can be displayed in
    raw format.
-   in observables detailed pages, `summary` results is not displayed.

If templates are imported into TheHive:

-   Short reports are displayed in Observables list and Observable
    detailed page

![VT short report](img/sc-short-vt.png){width="100px"}

-   Long reports are displayed when clicking on short reports or in
    Observable detailed page.

![VT long report](img/sc-long-vt.jpg){width="600px"}

### Writing templates

To display results into TheHive it is possible to write html templates
and feed TheHive with ; one file for long report and another for short
report.

If the analyzer is made for different services, there should be
templates for each of these. For example, for the VirusTotal analyzer:

``` {.sourceCode .bash}
thehive-templates/VirusTotal_GetReport_3_0
├── long.html
└── short.html
thehive-templates/VirusTotal_Scan_3_0
├── long.html
└── short.html
```

The folder's name is built with the `name` and the `version` found on
JSON files analyzers definition.

TheHive uses Bootstrap and AngularJS so they can be used in templates.

#### Short report template (short.html)

Until July'17, `short report` has been normalized to use taxonomies and
is built into the analyzers by the `summary()` function. We then updated
all short report templates to be able to read it :

``` {.sourceCode .html}
<span class="label" ng-repeat="t in content.taxonomies"
  ng-class="{'info': 'label-info', 'safe': 'label-success',
  'suspicious': 'label-warning',
  'malicious':'label-danger'}[t.level]">
    {{t.namespace}}:{{t.predicate}}={{t.value}}
</span>
```

If you want to change of add information display in short report in
observables detailed information page, you have to update the
`summary()` function in the analyzer's program and edit this file as
well. Basically, copy the code in your *short.html* template and it will
do the job.

#### Long report template (long.html)

Long report template is free to write as long as it is valid JSON
formatted. Basically, feel free to check what has already been written
for existing analyzers to help you start writing it.

A good start can be :

``` {.sourceCode .html}
<!-- Success -->
<div class="panel panel-danger" ng-if="success">
    <div class="panel-heading">
        ANALYZERNAME Report
    </div>
    <div class="panel-body">
        [...]                      <= code here
    </div>
</div>

<!-- General error  -->
<div class="panel panel-danger" ng-if="!success">
    <div class="panel-heading">
        <strong>{{(artifact.data || artifact.attachment.name) | fang}}</strong>
    </div>
    <div class="panel-body">
        <dl class="dl-horizontal" ng-if="content.errorMessage">
            <dt><i class="fa fa-warning"></i> ANALYZERNAME: </dt>
            <dd class="wrap">{{content.errorMessage}}</dd>
        </dl>
    </div>
</div>
```

Submit an analyzer
------------------

If you want to share your analyzer with the community through our Github
repository, we invite you to follow this guide.

Our reviews ensure that there is coherence between each analyzer, in the
way they are configured, run or displayed in TheHive. Here are some tips
you can check before submitting an analyzer.

### First rule

Consider creating one Pull Request per analyzer. We have to test and
review your analyzers, thus, this way provides the chance to release
them as quick as possible.

### Check your .json Configuration file(s)

By looking at VirusTotal analyzer, let's check JSON analyzer's
configuration file(s) :

``` {.sourceCode .json}
{
    "name": "VirusTotal_GetReport",
    "version": "3.0",
    "author": "CERT-BDF",
    "url": "https://github.com/CERT-BDF/Cortex-Analyzers",
    "license": "AGPL-V3",
    "description": "Get the latest VirusTotal report for a file, hash, domain or an IP address",
    "dataTypeList": ["file", "hash", "domain", "ip"],
    "baseConfig": "VirusTotal",
    "config": {
        "check_tlp": true,
        "max_tlp": 3,
        "service": "get"
    },
    "command": "VirusTotal/virustotal.py"
}
```

Ensure that all information is right and particularly `author` and
`license` are what you expect.

### Requirements file

If written in python language, be sure to complete the
`requirements.txt` file with the list of external library needed to run
the analyzer correctly.

### summary()

We chose to use a formatted summary report to match a taxonomy as
described above. This, to display short reports in the Observables list
in TheHive. If you want your analyzer reports in the Observable lists,
ensure that your summary matches this format. If your analyzer is
written in Python language and you are using our cortexutils library,
you can use summary() and `build_taxonomy()` functions.

### Global configuration in Cortex

When submitting your analyzer, please provide the necessary global
configuration in `/etc/cortex/application.conf` if needed.

### Simple checks

-   \[ \] Works with waited configuration, TLP or dataType
-   \[ \] Works with missing configuration, dataType or TLP : report
    explicit error message
-   \[ \] long report template manage error messages

